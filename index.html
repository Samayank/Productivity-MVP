<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Productivity RPG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .task-item:hover .delete-task {
            opacity: 1;
        }
        #character-viewer {
            height: 180px;
            cursor: grab;
        }
        #character-viewer:active {
            cursor: grabbing;
        }
        .loader {
            border: 4px solid #4a5568;
            border-top: 4px solid #4299e1;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .boss-battle-card {
            background: linear-gradient(145deg, #4a0e0e, #8b1a1a);
            border: 2px solid #ff5555;
        }
    </style>
</head>
<body class="bg-gray-900 text-white antialiased">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">

        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-cyan-400 tracking-tight">Productivity RPG</h1>
            <p class="text-gray-400 mt-2">Level up your life, one task at a time.</p>
        </header>

        <!-- Character Stats Panel -->
        <div class="bg-gray-800 rounded-2xl p-6 mb-8 shadow-lg border border-gray-700">
             <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                <div>
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center space-x-2">
                            <h3 id="character-name" class="text-xl font-bold text-cyan-400">Adventurer</h3>
                            <span id="rank-badge" class="text-xs bg-emerald-500 text-gray-900 font-bold px-2 py-0.5 rounded-full">Adventurer</span>
                        </div>
                        <button id="edit-name-btn" class="text-gray-400 hover:text-cyan-400 transition" title="Edit Character Name">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                            </svg>
                        </button>
                    </div>
                    <div id="character-viewer" class="bg-gray-900 rounded-lg relative">
                         <button id="create-from-photo-btn" class="absolute top-2 right-2 bg-gray-700 hover:bg-gray-600 text-white font-bold p-2 rounded-full transition" title="Create Character from Photo">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <div class="absolute bottom-2 left-2 flex items-center space-x-2 bg-gray-800/70 px-2 py-1 rounded">
                            <label for="gender-select" class="text-xs text-gray-300">Gender</label>
                            <select id="gender-select" class="bg-gray-700 text-white text-xs rounded px-1 py-0.5 focus:outline-none">
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="absolute top-2 left-2 bg-gray-800/80 px-2 py-1 rounded text-xs">
                            <span id="work-timer-display">00:00:00</span>
                        </div>
                    </div>
                </div>
                <div>
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-2xl font-bold text-white">Your Character</h2>
                        <div class="flex items-center space-x-4">
                            <div id="revive-potions" class="flex items-center" title="Revive Potions">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-pink-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" /></svg>
                                <span id="revive-potions-count" class="text-lg font-semibold ml-1">2</span>
                            </div>
                            <div class="text-lg font-semibold bg-cyan-500 text-gray-900 rounded-full px-4 py-1">Level: <span id="char-level">1</span></div>
                        </div>
                    </div>
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-1"><span class="font-semibold text-red-400">HP</span><span id="hp-text" class="text-sm font-medium">100 / 100</span></div>
                        <div class="w-full bg-gray-700 rounded-full h-4"><div id="hp-bar" class="bg-red-500 h-4 rounded-full transition-all duration-500" style="width: 100%;"></div></div>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-1"><span class="font-semibold text-yellow-400">XP</span><span id="xp-text" class="text-sm font-medium">0 / 100</span></div>
                        <div class="w-full bg-gray-700 rounded-full h-4"><div id="xp-bar" class="bg-yellow-500 h-4 rounded-full transition-all duration-500" style="width: 0%;"></div></div>
                    </div>
                    <button id="pep-talk-btn" class="mt-4 w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition flex items-center justify-center">
                        <span class="mr-2">‚ú®</span> Get Pep Talk
                    </button>
                     <div class="mt-3 grid grid-cols-3 gap-2">
                         <button id="timer-start-btn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-2 rounded-lg transition">Start</button>
                         <button id="timer-pause-btn" class="bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-2 rounded-lg transition">Pause</button>
                         <button id="day-complete-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-2 rounded-lg transition">Day Completed</button>
                     </div>
                    <button id="reset-game-btn" class="mt-2 w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition flex items-center justify-center">
                        <span class="mr-2">üîÑ</span> Reset Progress
                    </button>
                </div>
            </div>
        </div>

        <!-- Boss Battle Section -->
        <div id="boss-battle-section" class="mb-8"></div>

        <!-- Task Management -->
        <div class="bg-gray-800 rounded-2xl p-6 shadow-lg border border-gray-700 mb-8">
            <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                <h2 class="text-2xl font-bold text-white">Your Quests</h2>
                <div class="flex-shrink-0">
                    <button id="start-boss-battle-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105 mr-4">‚ú® Start Boss Battle</button>
                    <button id="add-task-btn" class="bg-cyan-500 hover:bg-cyan-600 text-gray-900 font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105">Add New Quest</button>
                </div>
            </div>
            <div id="task-list" class="space-y-4">
                 <p class="text-gray-500 text-center py-4">No quests yet. Add one to begin your adventure!</p>
            </div>
        </div>

                <!-- Friends & Leaderboard Section -->
        <div class="bg-gray-800 rounded-2xl p-6 shadow-lg border border-gray-700">
            <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                <h2 class="text-2xl font-bold text-white">Friends & Leaderboard</h2>
                <div class="flex-shrink-0">
                    <button id="login-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105 mr-4">üîê Login</button>
                    <button id="search-friend-btn" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105 mr-4">üîç Search User</button>
                    <button id="invite-friend-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105 mr-4">üìß Invite Friend</button>
                    <button id="refresh-leaderboard-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105">üîÑ Refresh</button>
                </div>
            </div>
            
            <!-- Friends List -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-300 mb-3">Your Friends</h3>
                <div id="friends-list" class="space-y-2">
                    <p class="text-gray-500 text-center py-4">No friends yet. Invite someone to start competing!</p>
                </div>
            </div>

            <!-- Leaderboard -->
            <div>
                <h3 class="text-lg font-semibold text-gray-300 mb-3">Leaderboard</h3>
                <div id="leaderboard" class="space-y-2">
                    <div class="flex items-center justify-center py-4">
                        <div class="loader"></div>
                        <span class="ml-2 text-gray-400">Loading leaderboard...</span>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="task-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50 overflow-y-auto">
        <div class="bg-gray-800 rounded-2xl p-8 shadow-2xl w-full max-w-md border border-gray-700 m-4">
            <h2 class="text-2xl font-bold mb-6 text-white">New Quest Details</h2>
            <form id="task-form">
                <div class="mb-4">
                    <label for="task-name" class="block text-gray-400 mb-2">Quest Title</label>
                    <input type="text" id="task-name" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500" required>
                </div>
                 <div class="mb-3">
                    <label for="task-description" class="block text-gray-400 mb-1">Quest Description</label>
                    <textarea id="task-description" rows="2" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500" placeholder="Describe your main goal... The AI will use this to generate subtasks."></textarea>
                </div>
                <div class="mb-4">
                    <label for="task-priority" class="block text-gray-400 mb-2">Priority</label>
                    <select id="task-priority" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500">
                        <option value="low" class="text-green-400">Low</option>
                        <option value="medium" class="text-yellow-400">Medium</option>
                        <option value="high" class="text-red-400">High</option>
                    </select>
                </div>
                <div class="mb-2">
                    <label for="subtasks" class="block text-gray-400 mb-1">Subtasks</label>
                    <textarea id="subtasks" rows="3" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500" placeholder="Enter subtasks, one per line..."></textarea>
                </div>
                <div class="mb-4 flex items-center justify-end">
                    <button type="button" id="generate-subtasks-btn" class="flex items-center text-cyan-400 hover:text-cyan-300 font-semibold py-2 px-4 rounded-lg transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M5 3a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2V5a2 2 0 00-2-2H5zm0 2h10v7h-2l-1 1-1-1H5V5z" /></svg>
                        Generate for Student
                    </button>
                     <div id="ai-loader" class="loader hidden ml-4"></div>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancel-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition">Cancel</button>
                    <button type="submit" class="bg-cyan-500 hover:bg-cyan-600 text-gray-900 font-bold py-2 px-4 rounded-lg transition">Add Quest</button>
                </div>
            </form>
        </div>
    </div>
    <div id="boss-battle-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 rounded-2xl p-8 shadow-2xl w-full max-w-md border border-gray-700 m-4">
            <h2 class="text-2xl font-bold mb-6 text-white">Summon a Boss</h2>
            <form id="boss-battle-form">
                <div class="mb-4">
                    <label for="boss-theme" class="block text-gray-400 mb-2">Boss Theme</label>
                    <input type="text" id="boss-theme" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="e.g., Final Exams, Project Deadline" required>
                </div>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" id="cancel-boss-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition">Cancel</button>
                    <button type="submit" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition flex items-center">
                        <span id="boss-loader" class="loader hidden mr-2"></span>
                        Summon
                    </button>
                </div>
            </form>
        </div>
    </div>
    <div id="message-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 rounded-2xl p-8 shadow-2xl w-full max-w-md border border-gray-700 m-4 text-center">
            <h2 id="message-title" class="text-2xl font-bold mb-4 text-cyan-400"></h2>
            <p id="message-body" class="text-gray-300 mb-6"></p>
            <button id="message-ok-btn" class="bg-cyan-500 hover:bg-cyan-600 text-gray-900 font-bold py-2 px-6 rounded-lg transition">OK</button>
        </div>
    </div>
    <div id="name-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 rounded-2xl p-8 shadow-2xl w-full max-w-md border border-gray-700 m-4">
            <h2 class="text-2xl font-bold mb-6 text-white">Name Your Character</h2>
            <div class="mb-6">
                <label for="character-name-input" class="block text-gray-400 mb-2">Character Name</label>
                <input type="text" id="character-name-input" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500" placeholder="Enter your character's name..." maxlength="20">
            </div>
            <div class="flex justify-end space-x-4">
                <button type="button" id="cancel-name-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition">Cancel</button>
                <button type="button" id="save-name-btn" class="bg-cyan-500 hover:bg-cyan-600 text-gray-900 font-bold py-2 px-4 rounded-lg transition">Save Name</button>
            </div>
        </div>
    </div>
    <div id="login-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 rounded-2xl p-8 shadow-2xl w-full max-w-md border border-gray-700 m-4">
            <h2 class="text-2xl font-bold mb-6 text-white">Create Account / Login</h2>
            <div class="mb-6">
                <label for="username-input" class="block text-gray-400 mb-2">Username</label>
                <input type="text" id="username-input" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Choose a unique username..." maxlength="20">
                <p class="text-sm text-gray-500 mt-2">This will be your public username for friends to find you.</p>
            </div>
            <div class="flex justify-end space-x-4">
                <button type="button" id="cancel-login-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition">Cancel</button>
                <button type="button" id="save-login-btn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg transition flex items-center">
                    <span id="login-loader" class="loader hidden mr-2"></span>
                    Save Username
                </button>
            </div>
        </div>
    </div>
    <div id="search-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 rounded-2xl p-8 shadow-2xl w-full max-w-md border border-gray-700 m-4">
            <h2 class="text-2xl font-bold mb-6 text-white">Search for Friends</h2>
            <div class="mb-6">
                <label for="search-username" class="block text-gray-400 mb-2">Username</label>
                <input type="text" id="search-username" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="Enter username to search...">
                <p class="text-sm text-gray-500 mt-2">Search for friends by their username to add them.</p>
            </div>
            <div id="search-results" class="mb-4"></div>
            <div class="flex justify-end space-x-4">
                <button type="button" id="cancel-search-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition">Cancel</button>
                <button type="button" id="search-user-btn" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg transition flex items-center">
                    <span id="search-loader" class="loader hidden mr-2"></span>
                    Search
                </button>
            </div>
        </div>
    </div>
    <div id="invite-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 rounded-2xl p-8 shadow-2xl w-full max-w-md border border-gray-700 m-4">
            <h2 class="text-2xl font-bold mb-6 text-white">Invite a Friend</h2>
            <div class="mb-6">
                <label for="friend-email" class="block text-gray-400 mb-2">Friend's Email</label>
                <input type="email" id="friend-email" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Enter your friend's email address...">
                <p class="text-sm text-gray-500 mt-2">They'll receive an invitation to join your productivity adventure!</p>
            </div>
            <div class="flex justify-end space-x-4">
                <button type="button" id="cancel-invite-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition">Cancel</button>
                <button type="button" id="send-invite-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition flex items-center">
                    <span id="invite-loader" class="loader hidden mr-2"></span>
                    Send Invite
                </button>
            </div>
        </div>
    </div>
    <div id="photo-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 rounded-2xl p-8 shadow-2xl w-full max-w-md border border-gray-700 m-4">
            <h2 class="text-2xl font-bold mb-6 text-white">Create Character from Photo</h2>
            <div class="mb-4">
                <label for="photo-upload" class="block text-gray-400 mb-2">Upload your picture</label>
                <input type="file" id="photo-upload" accept="image/*" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-cyan-500 file:text-gray-900 hover:file:bg-cyan-600">
            </div>
            <div id="photo-preview-container" class="mb-4 hidden">
                <img id="photo-preview" src="#" alt="Your photo" class="max-h-48 mx-auto rounded-lg">
            </div>
            <div class="flex justify-end space-x-4 mt-6">
                <button type="button" id="cancel-photo-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition">Cancel</button>
                <button type="button" id="submit-photo-btn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg transition flex items-center" disabled>
                    <span id="photo-loader" class="loader hidden mr-2"></span>
                    Generate
                </button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE MANAGEMENT ---
            let state = {
                character: { hp: 100, maxHp: 100, xp: 0, level: 1, xpToNextLevel: 100, revivePotions: 2 },
                tasks: [],
                bossBattle: null,
                characterCustomization: {
                    skinColor: '#ffdbac',
                    hairColor: '#1a1a1a',
                    hasGlasses: false,
                    name: 'Adventurer',
                    gender: 'male'
                },
                friends: [],
                userId: null,
                username: null,
                isLoggedIn: false
            };

            // Extend state with daily timer
            state.dailyTimer = state.dailyTimer || { isRunning: false, accumulatedMs: 0, startedAt: null };

            // --- PERSISTENCE FUNCTIONS ---
            function saveGameState() {
                const gameData = {
                    character: state.character,
                    tasks: state.tasks,
                    bossBattle: state.bossBattle,
                    characterCustomization: state.characterCustomization,
                    friends: state.friends,
                    userId: state.userId,
                    username: state.username,
                    isLoggedIn: state.isLoggedIn,
                    dailyTimer: state.dailyTimer,
                    lastSaved: Date.now()
                };
                localStorage.setItem('productivityRPG_save', JSON.stringify(gameData));
            }

            function loadGameState() {
                const savedData = localStorage.getItem('productivityRPG_save');
                if (savedData) {
                    try {
                        const gameData = JSON.parse(savedData);
                        
                        // Load character stats
                        if (gameData.character) {
                            state.character = { ...state.character, ...gameData.character };
                        }
                        
                        // Load tasks
                        if (gameData.tasks) {
                            state.tasks = gameData.tasks;
                        }
                        
                        // Load boss battle
                        if (gameData.bossBattle) {
                            state.bossBattle = gameData.bossBattle;
                        }
                        
                        // Load character customization
                        if (gameData.characterCustomization) {
                            state.characterCustomization = { ...state.characterCustomization, ...gameData.characterCustomization };
                        }
                        
                        // Load friends
                        if (gameData.friends) {
                            state.friends = gameData.friends;
                        }
                        
                        // Load userId
                        if (gameData.userId) {
                            state.userId = gameData.userId;
                        }
                        
                        // Load username and login state
                        if (gameData.username) {
                            state.username = gameData.username;
                        }
                        if (gameData.isLoggedIn !== undefined) {
                            state.isLoggedIn = gameData.isLoggedIn;
                        }
                        
                        // Load daily timer
                        if (gameData.dailyTimer) {
                            state.dailyTimer = { ...state.dailyTimer, ...gameData.dailyTimer };
                        }
                        
                        console.log('Game state loaded successfully');
                        return true;
                    } catch (error) {
                        console.error('Error loading game state:', error);
                        return false;
                    }
                }
                return false;
            }

            function resetGameState() {
                if (confirm('Are you sure you want to reset all progress? This cannot be undone.')) {
                    localStorage.removeItem('productivityRPG_save');
                    location.reload();
                }
            }

            // --- CONSTANTS ---
            const XP_PER_LEVEL_MULTIPLIER = 1.5, INITIAL_XP_TO_NEXT_LEVEL = 100, INITIAL_REVIVE_POTIONS = 2;
            const HP_GAIN_PER_LEVEL = 10;

            function getRankForLevel(level) {
                if (level >= 100) return 'Legend';
                if (level >= 80) return 'Hero';
                if (level >= 60) return 'Champion';
                if (level >= 40) return 'Knight';
                if (level >= 25) return 'Warrior';
                if (level >= 10) return 'Hunter';
                return 'Adventurer';
            }
            const PRIORITY_VALUES = {
                low: { xp: 10, hpLoss: 5, completionBonus: 5 },
                medium: { xp: 20, hpLoss: 10, completionBonus: 10 },
                high: { xp: 40, hpLoss: 20, completionBonus: 20 },
            };

            // --- DOM ELEMENTS ---
            const characterViewer = document.getElementById('character-viewer');
            const createFromPhotoBtn = document.getElementById('create-from-photo-btn');
            const photoModal = document.getElementById('photo-modal');
            const cancelPhotoBtn = document.getElementById('cancel-photo-btn');
            const submitPhotoBtn = document.getElementById('submit-photo-btn');
            const photoUpload = document.getElementById('photo-upload');
            const photoPreviewContainer = document.getElementById('photo-preview-container');
            const photoPreview = document.getElementById('photo-preview');
            const photoLoader = document.getElementById('photo-loader');
            const characterNameDisplay = document.getElementById('character-name');
            const rankBadge = document.getElementById('rank-badge');
            const genderSelect = document.getElementById('gender-select');
            const editNameBtn = document.getElementById('edit-name-btn');
            const nameModal = document.getElementById('name-modal');
            const characterNameInput = document.getElementById('character-name-input');
            const cancelNameBtn = document.getElementById('cancel-name-btn');
            const saveNameBtn = document.getElementById('save-name-btn');
            const charLevel = document.getElementById('char-level'), revivePotionsCount = document.getElementById('revive-potions-count'), hpBar = document.getElementById('hp-bar'), hpText = document.getElementById('hp-text'), xpBar = document.getElementById('xp-bar'), xpText = document.getElementById('xp-text'), taskList = document.getElementById('task-list'), addTaskBtn = document.getElementById('add-task-btn'), taskModal = document.getElementById('task-modal'), cancelBtn = document.getElementById('cancel-btn'), taskForm = document.getElementById('task-form'), messageModal = document.getElementById('message-modal'), messageTitle = document.getElementById('message-title'), messageBody = document.getElementById('message-body'), messageOkBtn = document.getElementById('message-ok-btn'), generateSubtasksBtn = document.getElementById('generate-subtasks-btn'), aiLoader = document.getElementById('ai-loader'), pepTalkBtn = document.getElementById('pep-talk-btn'), resetGameBtn = document.getElementById('reset-game-btn'), bossBattleSection = document.getElementById('boss-battle-section'), startBossBattleBtn = document.getElementById('start-boss-battle-btn'), bossBattleModal = document.getElementById('boss-battle-modal'), cancelBossBtn = document.getElementById('cancel-boss-btn'), bossBattleForm = document.getElementById('boss-battle-form'), bossLoader = document.getElementById('boss-loader'), loginBtn = document.getElementById('login-btn'), searchFriendBtn = document.getElementById('search-friend-btn'), inviteFriendBtn = document.getElementById('invite-friend-btn'), refreshLeaderboardBtn = document.getElementById('refresh-leaderboard-btn'), friendsList = document.getElementById('friends-list'), leaderboard = document.getElementById('leaderboard'), loginModal = document.getElementById('login-modal'), usernameInput = document.getElementById('username-input'), cancelLoginBtn = document.getElementById('cancel-login-btn'), saveLoginBtn = document.getElementById('save-login-btn'), loginLoader = document.getElementById('login-loader'), searchModal = document.getElementById('search-modal'), searchUsername = document.getElementById('search-username'), cancelSearchBtn = document.getElementById('cancel-search-btn'), searchUserBtn = document.getElementById('search-user-btn'), searchLoader = document.getElementById('search-loader'), searchResults = document.getElementById('search-results'), inviteModal = document.getElementById('invite-modal'), friendEmail = document.getElementById('friend-email'), cancelInviteBtn = document.getElementById('cancel-invite-btn'), sendInviteBtn = document.getElementById('send-invite-btn'), inviteLoader = document.getElementById('invite-loader');
            const workTimerDisplay = document.getElementById('work-timer-display');
            const timerStartBtn = document.getElementById('timer-start-btn');
            const timerPauseBtn = document.getElementById('timer-pause-btn');
            const dayCompleteBtn = document.getElementById('day-complete-btn');


            // --- 3D Character Setup ---
            let scene, camera, renderer, character, characterParts = {};
            
            function rebuildCharacter() {
                if (character) {
                    scene.remove(character);
                }
                character = createCharacter(state.characterCustomization);
                scene.add(character);
            }

            function createCharacter({ skinColor, hairColor, hasGlasses }) {
                const group = new THREE.Group();
                const level = state.character.level;
                const gender = state.characterCustomization.gender || 'male';

                // Materials
                const headMat = new THREE.MeshStandardMaterial({ color: skinColor });
                const hairMat = new THREE.MeshStandardMaterial({ color: hairColor });
                const tunicColorByRank = {
                    Adventurer: 0x5a2d0c,
                    Hunter: 0x2d5a3a,
                    Warrior: 0x2d3c5a,
                    Knight: 0x5a2d4f,
                    Champion: 0x5a4a2d,
                    Hero: 0x8a6a1a,
                    Legend: 0xa85a0a
                };
                const tunicMat = new THREE.MeshStandardMaterial({ color: tunicColorByRank[getRankForLevel(level)] });
                const pantsMat = new THREE.MeshStandardMaterial({ color: 0x3d3d3d });
                const batMat = new THREE.MeshStandardMaterial({ color: 0x4a2c0f });
                const swordMat = new THREE.MeshStandardMaterial({ color: 0xcccccc, metalness: 0.8, roughness: 0.3 });
                const shieldMat = new THREE.MeshStandardMaterial({ color: 0x888888, metalness: 0.6, roughness: 0.5 });
                const armorMat = new THREE.MeshStandardMaterial({ color: 0x777777, metalness: 0.9, roughness: 0.2 });
                const enchantedMat = new THREE.MeshStandardMaterial({ color: 0x00ffff, emissive: 0x005555, emissiveIntensity: 0.4 });
                const glassesMat = new THREE.MeshStandardMaterial({ color: 0x1a1a1a });

                // Head - slight size differences by gender
                const headSize = gender === 'female' ? [0.65, 0.65, 0.65] : gender === 'other' ? [0.68, 0.68, 0.68] : [0.7, 0.7, 0.7];
                const head = new THREE.Mesh(new THREE.BoxGeometry(...headSize), headMat);
                head.position.y = 2.4;
                group.add(head);

                // Hair - longer for female
                const hairHeight = gender === 'female' ? 0.45 : 0.3;
                characterParts.hair = new THREE.Mesh(new THREE.BoxGeometry(0.75, hairHeight, 0.75), hairMat);
                characterParts.hair.position.y = 2.8 + (hairHeight - 0.3) / 2;
                group.add(characterParts.hair);

                // Glasses
                if (hasGlasses) {
                    const glassesFrame = new THREE.Group();
                    const lensGeo = new THREE.BoxGeometry(0.25, 0.2, 0.05);
                    const leftLens = new THREE.Mesh(lensGeo, glassesMat);
                    leftLens.position.x = -0.2;
                    const rightLens = new THREE.Mesh(lensGeo, glassesMat);
                    rightLens.position.x = 0.2;
                    const bridge = new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.05, 0.05), glassesMat);
                    glassesFrame.add(leftLens, rightLens, bridge);
                    glassesFrame.position.set(0, 2.45, 0.35);
                    group.add(glassesFrame);
                }
                
                // Body - proportions vary slightly by gender
                const torsoWidth = gender === 'female' ? 0.9 : gender === 'other' ? 0.95 : 1.0;
                const torsoHeight = 1.2;
                const torso = new THREE.Mesh(new THREE.BoxGeometry(torsoWidth, torsoHeight, 0.5), tunicMat);
                torso.position.y = 1.4;
                group.add(torso);

                const armGeo = new THREE.BoxGeometry(0.28, 1.2, 0.28);
                const leftArm = new THREE.Mesh(armGeo, tunicMat);
                leftArm.position.set(-0.65, 1.4, 0);
                group.add(leftArm);
                const rightArm = new THREE.Mesh(armGeo, tunicMat);
                rightArm.position.set(0.65, 1.4, 0);
                group.add(rightArm);

                const legWidth = gender === 'female' ? 0.35 : 0.4;
                const legGeo = new THREE.BoxGeometry(legWidth, 1.2, legWidth);
                const leftLeg = new THREE.Mesh(legGeo, pantsMat);
                leftLeg.position.set(-0.3, 0.2, 0);
                group.add(leftLeg);
                const rightLeg = new THREE.Mesh(legGeo, pantsMat);
                rightLeg.position.set(0.3, 0.2, 0);
                group.add(rightLeg);

                // Base weapon: bat
                let weapon;
                if (level < 10) {
                    weapon = new THREE.Mesh(new THREE.CylinderGeometry(0.08, 0.12, 1.6, 8), batMat);
                    weapon.position.set(0.8, 1.2, 0.5);
                    weapon.rotation.z = THREE.MathUtils.degToRad(20);
                    weapon.rotation.x = THREE.MathUtils.degToRad(-10);
                } else {
                    // Sword from level 10+
                    const blade = new THREE.Mesh(new THREE.BoxGeometry(0.1, 1.6, 0.1), level >= 80 ? enchantedMat : swordMat);
                    blade.position.set(0.9, 1.4, 0.2);
                    const hilt = new THREE.Mesh(new THREE.BoxGeometry(0.15, 0.2, 0.15), shieldMat);
                    hilt.position.set(0.9, 0.6, 0.2);
                    weapon = new THREE.Group();
                    weapon.add(blade, hilt);
                }
                group.add(weapon);

                // Shield at level 25+
                if (level >= 25) {
                    const shield = new THREE.Mesh(new THREE.CylinderGeometry(0.6, 0.6, 0.1, 24), shieldMat);
                    shield.rotation.x = THREE.MathUtils.degToRad(90);
                    shield.position.set(-1.0, 1.2, 0.1);
                    group.add(shield);
                }

                // Armor overlays at milestones 40+, 60+
                if (level >= 40) {
                    const chestPlate = new THREE.Mesh(new THREE.BoxGeometry(torsoWidth + 0.1, 0.8, 0.55), armorMat);
                    chestPlate.position.set(0, 1.5, 0);
                    group.add(chestPlate);
                }
                if (level >= 60) {
                    const shoulderLeft = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.25, 0.5), armorMat);
                    shoulderLeft.position.set(-0.9, 2.0, 0);
                    const shoulderRight = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.25, 0.5), armorMat);
                    shoulderRight.position.set(0.9, 2.0, 0);
                    group.add(shoulderLeft, shoulderRight);
                }

                // Cape at 100
                if (level >= 100) {
                    const cape = new THREE.Mesh(new THREE.PlaneGeometry(1.4, 2.0), new THREE.MeshStandardMaterial({ color: 0xffaa00, side: THREE.DoubleSide }));
                    cape.position.set(0, 1.2, -0.3);
                    cape.rotation.x = THREE.MathUtils.degToRad(10);
                    group.add(cape);
                }

                return group;
            }

            function init3DScene() {
                scene = new THREE.Scene();
                camera = new THREE.PerspectiveCamera(75, characterViewer.clientWidth / characterViewer.clientHeight, 0.1, 1000);
                camera.position.set(0, 1.6, 4);
                camera.lookAt(0, 1.2, 0);

                renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                renderer.setSize(characterViewer.clientWidth, characterViewer.clientHeight);
                renderer.setPixelRatio(window.devicePixelRatio);
                characterViewer.appendChild(renderer.domElement);

                const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
                scene.add(ambientLight);
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(5, 10, 7.5);
                scene.add(directionalLight);

                rebuildCharacter();

                let isDragging = false, prevMouseX = 0;
                const onPointerDown = (e) => { isDragging = true; prevMouseX = e.clientX || e.touches[0].clientX; };
                const onPointerUp = () => { isDragging = false; };
                const onPointerMove = (e) => {
                    if (!isDragging) return;
                    const currentX = e.clientX || e.touches[0].clientX;
                    const deltaX = currentX - prevMouseX;
                    character.rotation.y += deltaX * 0.01;
                    prevMouseX = currentX;
                };

                characterViewer.addEventListener('mousedown', onPointerDown);
                characterViewer.addEventListener('mouseup', onPointerUp);
                characterViewer.addEventListener('mouseleave', onPointerUp);
                characterViewer.addEventListener('mousemove', onPointerMove);
                characterViewer.addEventListener('touchstart', onPointerDown, { passive: true });
                characterViewer.addEventListener('touchend', onPointerUp);
                characterViewer.addEventListener('touchmove', onPointerMove, { passive: true });

                animateCharacter();
            }

            function animateCharacter() {
                requestAnimationFrame(animateCharacter);
                if (character) {
                    character.position.y = Math.sin(Date.now() * 0.002) * 0.05;
                }
                renderer.render(scene, camera);
            }
            
            window.addEventListener('resize', () => {
                if(renderer && camera){
                    camera.aspect = characterViewer.clientWidth / characterViewer.clientHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(characterViewer.clientWidth, characterViewer.clientHeight);
                }
            });

            // --- CORE LOGIC ---
            function showMessage(title, body) {
                messageTitle.textContent = title;
                messageBody.innerHTML = body.replace(/\n/g, '<br>');
                messageModal.classList.remove('hidden');
            }

            function updateCharacterStats() {
                const { hp, maxHp, xp, level, xpToNextLevel, revivePotions } = state.character;
                charLevel.textContent = level;
                revivePotionsCount.textContent = revivePotions;
                const hpPercent = (hp / maxHp) * 100;
                hpBar.style.width = `${hpPercent}%`;
                hpText.textContent = `${Math.round(hp)} / ${maxHp}`;
                const xpPercent = (xp / xpToNextLevel) * 100;
                xpBar.style.width = `${xpPercent}%`;
                xpText.textContent = `${Math.round(xp)} / ${xpToNextLevel}`;
                updateRankUI();
            }

            function updateRankUI() {
                const currentRank = getRankForLevel(state.character.level);
                if (rankBadge) {
                    rankBadge.textContent = currentRank;
                    // simple color change by rank tier
                    rankBadge.className = 'text-xs font-bold px-2 py-0.5 rounded-full ' + (
                        currentRank === 'Adventurer' ? 'bg-emerald-500 text-gray-900' :
                        currentRank === 'Hunter' ? 'bg-teal-400 text-gray-900' :
                        currentRank === 'Warrior' ? 'bg-indigo-400 text-gray-900' :
                        currentRank === 'Knight' ? 'bg-purple-400 text-gray-900' :
                        currentRank === 'Champion' ? 'bg-pink-400 text-gray-900' :
                        currentRank === 'Hero' ? 'bg-yellow-400 text-gray-900' :
                        'bg-orange-400 text-gray-900'
                    );
                }
            }

            // --- DAILY TIMER ---
            let timerInterval = null;
            function formatMs(ms) {
                const totalSec = Math.floor(ms / 1000);
                const h = String(Math.floor(totalSec / 3600)).padStart(2, '0');
                const m = String(Math.floor((totalSec % 3600) / 60)).padStart(2, '0');
                const s = String(totalSec % 60).padStart(2, '0');
                return `${h}:${m}:${s}`;
            }
            function updateTimerDisplay() {
                if (!workTimerDisplay) return;
                let elapsed = state.dailyTimer.accumulatedMs;
                if (state.dailyTimer.isRunning && state.dailyTimer.startedAt) {
                    elapsed += Date.now() - state.dailyTimer.startedAt;
                }
                workTimerDisplay.textContent = formatMs(elapsed);
            }
            function startTimer() {
                if (state.dailyTimer.isRunning) return;
                state.dailyTimer.isRunning = true;
                state.dailyTimer.startedAt = Date.now();
                if (timerInterval) clearInterval(timerInterval);
                timerInterval = setInterval(updateTimerDisplay, 1000);
                saveGameState();
                updateTimerDisplay();
            }
            function pauseTimer() {
                if (!state.dailyTimer.isRunning) return;
                state.dailyTimer.isRunning = false;
                if (state.dailyTimer.startedAt) {
                    state.dailyTimer.accumulatedMs += Date.now() - state.dailyTimer.startedAt;
                    state.dailyTimer.startedAt = null;
                }
                if (timerInterval) clearInterval(timerInterval);
                timerInterval = null;
                saveGameState();
                updateTimerDisplay();
            }
            function completeDay() {
                // Pause timer, compute total, reset only after confirmation
                pauseTimer();
                const totalMs = state.dailyTimer.accumulatedMs;
                const timeText = formatMs(totalMs);
                showMessage('Day Completed', `Great work! You logged ${timeText} today. Rewards have been granted!`);
                // Grant small XP based on time (1 XP per 5 minutes)
                const bonusXp = Math.floor(totalMs / (5 * 60 * 1000));
                if (bonusXp > 0) gainXp(bonusXp);
                // Reset timer only now
                state.dailyTimer = { isRunning: false, accumulatedMs: 0, startedAt: null };
                saveGameState();
                updateTimerDisplay();
            }

            function updateCharacterName() {
                characterNameDisplay.textContent = state.characterCustomization.name;
            }

            // --- FRIENDS & LEADERBOARD FUNCTIONS ---
            function generateUserId() {
                if (!state.userId) {
                    state.userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    saveGameState();
                }
                return state.userId;
            }

            function renderFriendsList() {
                if (state.friends.length === 0) {
                    friendsList.innerHTML = '<p class="text-gray-500 text-center py-4">No friends yet. Invite someone to start competing!</p>';
                    return;
                }

                friendsList.innerHTML = state.friends.map(friend => `
                    <div class="flex items-center justify-between bg-gray-700 p-3 rounded-lg">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-cyan-500 rounded-full flex items-center justify-center text-white font-bold text-sm mr-3">
                                ${friend.name.charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <div class="font-semibold text-white">${friend.name}</div>
                                <div class="text-sm text-gray-400">Level ${friend.level}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-gray-400">${friend.email}</div>
                            <div class="text-xs text-gray-500">${friend.status}</div>
                        </div>
                    </div>
                `).join('');
            }

            async function renderLeaderboard() {
                try {
                    // Update user stats in global registry first
                    updateGlobalUserStats();
                    
                    // Get fresh data from global registry for friends
                    const globalUsers = getGlobalUserRegistry();
                    
                    // Create leaderboard with current user
                    const leaderboardData = [
                        { name: state.characterCustomization.name, level: state.character.level, xp: state.character.xp, isCurrentUser: true }
                    ];

                    // Add friends with updated stats from global registry
                    state.friends.forEach(friend => {
                        if (friend.username && friend.status === 'Connected') {
                            const globalUserData = globalUsers[friend.username.toLowerCase()];
                            if (globalUserData) {
                                // Update local friend data with latest from global registry
                                friend.level = globalUserData.level;
                                friend.xp = globalUserData.xp;
                                friend.name = globalUserData.characterName;
                            }
                            
                            leaderboardData.push({
                                name: friend.name,
                                level: friend.level,
                                xp: friend.xp || 0,
                                isCurrentUser: false
                            });
                        }
                    });
                    
                    // Save updated friends data
                    saveGameState();

                    // Sort by level (descending), then by XP (descending)
                    leaderboardData.sort((a, b) => {
                        if (b.level !== a.level) return b.level - a.level;
                        return b.xp - a.xp;
                    });

                    if (leaderboardData.length === 1) {
                        // Only current user - show solo message
                        leaderboard.innerHTML = `
                            <div class="flex items-center justify-between bg-gray-700 p-3 rounded-lg border-2 border-cyan-500">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 bg-yellow-500 rounded-full flex items-center justify-center text-white font-bold text-sm mr-3">
                                        1
                                    </div>
                                    <div>
                                        <div class="font-semibold text-white flex items-center">
                                            ${leaderboardData[0].name}
                                            <span class="ml-2 text-xs bg-cyan-500 text-white px-2 py-1 rounded">You</span>
                                        </div>
                                        <div class="text-sm text-gray-400">Level ${leaderboardData[0].level} ‚Ä¢ ${leaderboardData[0].xp} XP</div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-lg font-bold text-yellow-400">#1</div>
                                </div>
                            </div>
                            <p class="text-gray-500 text-center py-4 mt-4">You're the first adventurer! Invite friends to start competing.</p>
                        `;
                    } else {
                        // Multiple players
                        leaderboard.innerHTML = leaderboardData.map((player, index) => `
                            <div class="flex items-center justify-between bg-gray-700 p-3 rounded-lg ${player.isCurrentUser ? 'border-2 border-cyan-500' : ''}">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 ${index === 0 ? 'bg-yellow-500' : index === 1 ? 'bg-gray-400' : index === 2 ? 'bg-yellow-600' : 'bg-gray-600'} rounded-full flex items-center justify-center text-white font-bold text-sm mr-3">
                                        ${index + 1}
                                    </div>
                                    <div>
                                        <div class="font-semibold text-white flex items-center">
                                            ${player.name}
                                            ${player.isCurrentUser ? '<span class="ml-2 text-xs bg-cyan-500 text-white px-2 py-1 rounded">You</span>' : ''}
                                        </div>
                                        <div class="text-sm text-gray-400">Level ${player.level} ‚Ä¢ ${player.xp} XP</div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-lg font-bold ${index === 0 ? 'text-yellow-400' : index === 1 ? 'text-gray-300' : index === 2 ? 'text-yellow-600' : 'text-gray-400'}">
                                        #${index + 1}
                                    </div>
                                </div>
                            </div>
                        `).join('');
                    }
                } catch (error) {
                    console.error('Error loading leaderboard:', error);
                    leaderboard.innerHTML = '<p class="text-red-400 text-center py-4">Failed to load leaderboard. Please try again.</p>';
                }
            }

            async function sendFriendInvite(email) {
                try {
                    inviteLoader.classList.remove('hidden');
                    sendInviteBtn.disabled = true;

                    // Real email sending implementation
                    const inviteData = {
                        to: email,
                        from: 'noreply@productivityrpg.com', // Replace with your domain
                        subject: `${state.characterCustomization.name} invited you to join Productivity RPG!`,
                        html: `
                            <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background: #1a1a1a; color: white;">
                                <h1 style="color: #00ffff; text-align: center;">Productivity RPG</h1>
                                <p>Hey there!</p>
                                <p><strong>${state.characterCustomization.name}</strong> (Level ${state.character.level}) has invited you to join their productivity adventure!</p>
                                <p>Productivity RPG is a fun way to level up your life by completing tasks and competing with friends.</p>
                                <div style="background: #333; padding: 20px; border-radius: 10px; margin: 20px 0; text-align: center;">
                                    <h2 style="color: #00ffff;">Join the Adventure!</h2>
                                    <p>Click the button below to start your journey:</p>
                                    <a href="${window.location.origin}?invite=${state.userId}" style="display: inline-block; background: #00ffff; color: #1a1a1a; padding: 15px 30px; text-decoration: none; border-radius: 8px; font-weight: bold; margin: 10px;">Start Your Adventure</a>
                                </div>
                                <p style="font-size: 14px; color: #888;">This invitation was sent from Productivity RPG. If you didn't expect this email, you can safely ignore it.</p>
                            </div>
                        `
                    };

                    // Initialize EmailJS (you'll need to replace with your actual public key)
                    EmailJS.init("YOUR_PUBLIC_KEY"); // Replace with your EmailJS public key
                    
                    // Send email using EmailJS
                    const templateParams = {
                        to_email: email,
                        from_name: state.characterCustomization.name,
                        user_level: state.character.level,
                        invite_link: `${window.location.origin}?invite=${state.userId}`,
                        message: `Hey! ${state.characterCustomization.name} (Level ${state.character.level}) has invited you to join Productivity RPG! Click the link to start your adventure: ${window.location.origin}?invite=${state.userId}`
                    };

                    await EmailJS.send('service_productivityrpg', 'template_invite', templateParams);

                    // Add to friends list with pending status
                    const newFriend = {
                        email: email,
                        name: email.split('@')[0], // Use email prefix as name
                        level: 1,
                        status: 'Invitation Sent',
                        invitedAt: Date.now()
                    };

                    state.friends.push(newFriend);
                    renderFriendsList();
                    saveGameState();

                    showMessage("Invitation Sent!", `An invitation has been sent to ${email}. They'll receive an email to join your productivity adventure!`);
                    
                } catch (error) {
                    console.error('Error sending invite:', error);
                    showMessage("Invitation Failed", "Sorry, we couldn't send the invitation right now. Please try again later.");
                } finally {
                    inviteLoader.classList.add('hidden');
                    sendInviteBtn.disabled = false;
                }
            }

            // --- SHARED USER REGISTRY FUNCTIONS ---
            function getGlobalUserRegistry() {
                try {
                    const registry = localStorage.getItem('productivityRPG_globalUsers');
                    return registry ? JSON.parse(registry) : {};
                } catch (error) {
                    console.error('Error loading global user registry:', error);
                    return {};
                }
            }

            function saveToGlobalUserRegistry(username, userData) {
                try {
                    const registry = getGlobalUserRegistry();
                    registry[username.toLowerCase()] = {
                        username: username,
                        characterName: userData.characterName,
                        level: userData.level,
                        xp: userData.xp,
                        userId: userData.userId,
                        lastActive: Date.now()
                    };
                    localStorage.setItem('productivityRPG_globalUsers', JSON.stringify(registry));
                    return true;
                } catch (error) {
                    console.error('Error saving to global user registry:', error);
                    return false;
                }
            }

            function updateGlobalUserStats() {
                if (state.username && state.isLoggedIn) {
                    saveToGlobalUserRegistry(state.username, {
                        characterName: state.characterCustomization.name,
                        level: state.character.level,
                        xp: state.character.xp,
                        userId: state.userId
                    });
                }
            }

            // --- AUTHORIZATION FUNCTIONS ---
            async function saveUsername(username) {
                try {
                    loginLoader.classList.remove('hidden');
                    saveLoginBtn.disabled = true;

                    // Simulate API call delay
                    await new Promise(resolve => setTimeout(resolve, 1000));

                    // Check if username already exists in global registry
                    const globalUsers = getGlobalUserRegistry();
                    if (globalUsers[username.toLowerCase()]) {
                        throw new Error('Username already taken');
                    }

                    // Save username locally
                    state.username = username;
                    state.isLoggedIn = true;
                    
                    // Generate userId if not exists
                    if (!state.userId) {
                        state.userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    }
                    
                    // Register user globally
                    saveToGlobalUserRegistry(username, {
                        characterName: state.characterCustomization.name,
                        level: state.character.level,
                        xp: state.character.xp,
                        userId: state.userId
                    });
                    
                    saveGameState();

                    showMessage("Username Saved!", `Your username "${username}" has been saved. Friends can now find you by searching for your username!`);
                    loginModal.classList.add('hidden');
                    
                } catch (error) {
                    console.error('Error saving username:', error);
                    if (error.message === 'Username already taken') {
                        showMessage("Username Taken", "This username is already taken. Please choose a different one.");
                    } else {
                        showMessage("Save Failed", "Sorry, we couldn't save your username right now. Please try again.");
                    }
                } finally {
                    loginLoader.classList.add('hidden');
                    saveLoginBtn.disabled = false;
                }
            }

            async function searchUser(username) {
                try {
                    searchLoader.classList.remove('hidden');
                    searchUserBtn.disabled = true;

                    // Simulate API call delay
                    await new Promise(resolve => setTimeout(resolve, 1000));

                    // Search in global user registry
                    const globalUsers = getGlobalUserRegistry();
                    const foundUser = globalUsers[username.toLowerCase()];

                    if (foundUser) {
                        // Check if this is the current user
                        if (foundUser.username.toLowerCase() === state.username?.toLowerCase()) {
                            searchResults.innerHTML = `
                                <div class="bg-gray-700 p-3 rounded-lg text-center">
                                    <div class="text-gray-400">That's you! You can't add yourself as a friend.</div>
                                </div>
                            `;
                            return;
                        }

                        // Check if already friends
                        const isAlreadyFriend = state.friends.some(friend => 
                            friend.username?.toLowerCase() === foundUser.username.toLowerCase()
                        );

                        if (isAlreadyFriend) {
                            searchResults.innerHTML = `
                                <div class="bg-gray-700 p-3 rounded-lg">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <div class="font-semibold text-white">@${foundUser.username}</div>
                                            <div class="text-sm text-gray-400">Level ${foundUser.level} ‚Ä¢ ${foundUser.characterName}</div>
                                        </div>
                                        <span class="text-sm text-gray-500">Already friends</span>
                                    </div>
                                </div>
                            `;
                        } else {
                            searchResults.innerHTML = `
                                <div class="bg-gray-700 p-3 rounded-lg">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <div class="font-semibold text-white">@${foundUser.username}</div>
                                            <div class="text-sm text-gray-400">Level ${foundUser.level} ‚Ä¢ ${foundUser.characterName}</div>
                                        </div>
                                        <button onclick="addFriendByUsername('${foundUser.username}', '${foundUser.characterName}', ${foundUser.level}, ${foundUser.xp})" class="bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded text-sm transition">
                                            Add Friend
                                        </button>
                                    </div>
                                </div>
                            `;
                        }
                    } else {
                        searchResults.innerHTML = `
                            <div class="bg-gray-700 p-3 rounded-lg text-center">
                                <div class="text-gray-400">No user found with username "@${username}"</div>
                                <div class="text-xs text-gray-500 mt-1">Make sure they have created an account and chosen a username.</div>
                            </div>
                        `;
                    }
                    
                } catch (error) {
                    console.error('Error searching user:', error);
                    searchResults.innerHTML = `
                        <div class="bg-red-900 p-3 rounded-lg text-center">
                            <div class="text-red-400">Error searching for user. Please try again.</div>
                        </div>
                    `;
                } finally {
                    searchLoader.classList.add('hidden');
                    searchUserBtn.disabled = false;
                }
            }

            function addFriendByUsername(username, characterName, level, xp) {
                // Add friend to list with real data
                const newFriend = {
                    username: username,
                    name: characterName || username.charAt(0).toUpperCase() + username.slice(1),
                    level: level || 1,
                    xp: xp || 0,
                    status: 'Connected',
                    addedAt: Date.now()
                };

                state.friends.push(newFriend);
                renderFriendsList();
                saveGameState();

                showMessage("Friend Added!", `@${username} has been added to your friends list and will appear on the leaderboard!`);
                searchModal.classList.add('hidden');
                
                // Refresh leaderboard to show new friend
                renderLeaderboard();
            }

            async function levelUp() {
                state.character.level++;
                state.character.xp -= state.character.xpToNextLevel;
                // Increase XP requirement progressively
                state.character.xpToNextLevel = Math.floor(state.character.xpToNextLevel * XP_PER_LEVEL_MULTIPLIER);
                // Increase max HP and heal some
                state.character.maxHp += HP_GAIN_PER_LEVEL;
                state.character.hp = Math.min(state.character.maxHp, state.character.hp + Math.ceil(HP_GAIN_PER_LEVEL / 2));

                const newRank = getRankForLevel(state.character.level);
                let milestoneRewardText = '';
                // Milestone equipment and rewards
                if (state.character.level === 10) {
                    milestoneRewardText = '\nUnlocked Rank: Hunter\nNew Gear: Sword';
                } else if (state.character.level === 25) {
                    milestoneRewardText = '\nUnlocked Rank: Warrior\nNew Gear: Shield';
                } else if (state.character.level === 40) {
                    milestoneRewardText = '\nUnlocked Rank: Knight\nNew Gear: Light Armor';
                } else if (state.character.level === 60) {
                    milestoneRewardText = '\nUnlocked Rank: Champion\nNew Gear: Heavy Armor';
                } else if (state.character.level === 80) {
                    milestoneRewardText = '\nUnlocked Rank: Hero\nNew Gear: Enchanted Blade';
                } else if (state.character.level === 100) {
                    milestoneRewardText = '\nUnlocked Rank: Legend\nNew Gear: Legendary Set';
                }

                // Optional AI-based random reward
                let aiRewardText = '';
                try {
                    const prompt = `Suggest a short, fun, random reward title for a player reaching level ${state.character.level} in a productivity RPG (e.g., extra potion, cosmetic, title). Return only the reward in 5 words or fewer.`;
                    const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                    const apiKey = "AIzaSyAI4X1TowXLM2p_5ewiJkcj6jjhlnkg76g";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (response.ok) {
                        const result = await response.json();
                        const text = result.candidates?.[0]?.content?.parts?.[0]?.text?.trim();
                        if (text) aiRewardText = `\nRandom Reward: ${text}`;
                    }
                } catch(_) {}

                showMessage("Level Up!", `Congratulations! You've reached Level ${state.character.level}.` + milestoneRewardText + aiRewardText);
                rebuildCharacter();
                updateCharacterStats();
                saveGameState();
            }

            function gainXp(amount) {
                state.character.xp += amount;
                if (state.character.xp >= state.character.xpToNextLevel) {
                    levelUp();
                } else {
                    updateCharacterStats();
                }
                saveGameState();
            }

            function loseHp(amount) {
                state.character.hp = Math.max(0, state.character.hp - amount);
                
                if (state.character.hp === 0) {
                    if (state.character.revivePotions > 0) {
                        state.character.revivePotions--;
                        state.character.hp = state.character.maxHp;
                        showMessage("Revived!", `You were defeated, but a Revive Potion brought you back! You have ${state.character.revivePotions} left.`);
                    } else {
                        showMessage("Defeated!", "You have no revives left. Your power fades... You've been reset to Level 1.");
                        state.character.level = 1;
                        state.character.xp = 0;
                        state.character.xpToNextLevel = INITIAL_XP_TO_NEXT_LEVEL;
                        state.character.hp = state.character.maxHp;
                        state.character.revivePotions = INITIAL_REVIVE_POTIONS;
                    }
                }
                updateCharacterStats();
                saveGameState();
            }

            function renderTasks() {
                taskList.innerHTML = '';
                if (state.tasks.length === 0 && !state.bossBattle) {
                    taskList.innerHTML = '<p class="text-gray-500 text-center py-4">No quests yet. Add one to begin your adventure!</p>';
                    return;
                }
                state.tasks.forEach(task => {
                    const taskElement = document.createElement('div');
                    taskElement.className = `task-item bg-gray-700 p-4 rounded-lg border-l-4 ${getPriorityBorder(task.priority)}`;
                    
                    const allSubtasksComplete = task.subtasks.length > 0 && task.subtasks.every(st => st.completed);

                    let subtasksHtml = task.subtasks.map((subtask, index) => `
                        <div class="flex items-center mt-2">
                            <input type="checkbox" id="subtask-${task.id}-${index}" data-task-id="${task.id}" data-subtask-index="${index}" class="form-checkbox h-5 w-5 bg-gray-800 border-gray-600 text-cyan-500 rounded focus:ring-cyan-600" ${subtask.completed ? 'checked' : ''}>
                            <label for="subtask-${task.id}-${index}" class="ml-3 text-gray-300 ${subtask.completed ? 'line-through text-gray-500' : ''}">${subtask.name}</label>
                        </div>
                    `).join('');

                    const completeButtonHtml = `
                        <button data-task-id="${task.id}" class="complete-task-btn mt-4 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition ${allSubtasksComplete ? '' : 'hidden'}">
                            Complete Quest & Claim Bonus
                        </button>
                    `;

                    taskElement.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-lg font-bold ${allSubtasksComplete ? 'text-green-400' : 'text-white'}">${task.name}</h3>
                                <span class="text-sm font-medium px-2 py-0.5 rounded-full ${getPriorityBg(task.priority)}">${task.priority.charAt(0).toUpperCase() + task.priority.slice(1)}</span>
                            </div>
                            <div>
                                <button data-task-id="${task.id}" class="fail-task-btn text-gray-400 hover:text-red-500 transition mr-2" title="Mark as Failed">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" /></svg>
                                </button>
                                <button data-task-id="${task.id}" class="delete-task text-gray-400 hover:text-white transition opacity-0" title="Delete Task">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                </button>
                            </div>
                        </div>
                        <div class="mt-4">${subtasksHtml}</div>
                        ${completeButtonHtml}
                    `;
                    taskList.appendChild(taskElement);
                });
            }
            
            function getPriorityBorder(priority) {
                if (priority === 'high') return 'border-red-500';
                if (priority === 'medium') return 'border-yellow-500';
                return 'border-green-500';
            }

            function getPriorityBg(priority) {
                if (priority === 'high') return 'bg-red-500/20 text-red-300';
                if (priority === 'medium') return 'bg-yellow-500/20 text-yellow-300';
                return 'bg-green-500/20 text-green-300';
            }

            function addTask(name, priority, subtasksStr) {
                const subtasks = subtasksStr.split('\n').filter(s => s.trim() !== '').map(s => ({ name: s.trim(), completed: false }));
                const newTask = { id: Date.now(), name, priority, subtasks };
                state.tasks.push(newTask);
                renderTasks();
                saveGameState();
            }

            function deleteTask(taskId) {
                state.tasks = state.tasks.filter(task => task.id !== taskId);
                renderTasks();
                saveGameState();
            }

            function failTask(taskId) {
                const task = state.tasks.find(t => t.id === taskId);
                if (task) {
                    loseHp(PRIORITY_VALUES[task.priority].hpLoss);
                    deleteTask(taskId);
                }
            }
            
            function completeTask(taskId) {
                const task = state.tasks.find(t => t.id === taskId);
                if (task) {
                    gainXp(PRIORITY_VALUES[task.priority].completionBonus);
                    showMessage("Quest Complete!", `You finished "${task.name}" and earned a bonus! Well done.`);
                    deleteTask(taskId);
                }
            }

            function completeSubtask(taskId, subtaskIndex, isCompleted) {
                const task = state.tasks.find(t => t.id === taskId);
                if (task && task.subtasks[subtaskIndex] && task.subtasks[subtaskIndex].completed !== isCompleted) {
                     task.subtasks[subtaskIndex].completed = isCompleted;
                     const xpPerSubtask = (PRIORITY_VALUES[task.priority].xp / task.subtasks.length) || 0;
                     if (isCompleted) {
                         gainXp(xpPerSubtask);
                     } else {
                         gainXp(-xpPerSubtask);
                     }
                    renderTasks();
                    saveGameState();
                }
            }
            
            async function generateSubtasks() {
                const taskTitle = document.getElementById('task-name').value;
                const taskDescription = document.getElementById('task-description').value;

                if (!taskTitle && !taskDescription) {
                    showMessage("Error", "Please enter a quest title or description first.");
                    return;
                }

                generateSubtasksBtn.disabled = true;
                aiLoader.classList.remove('hidden');

                const prompt = `You are an assistant for a student. Break down the following academic task into a short list of simple, actionable subtasks. Consider steps like research, outlining, drafting, and reviewing. Use both the title and description for context. Return only the subtasks, each on a new line. Do not add any introductory text or bullet points.\n\nTask Title: "${taskTitle}"\n\nDescription: "${taskDescription}"`;
                
                try {
                    let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                    const payload = { contents: chatHistory };
                    const apiKey = "AIzaSyAI4X1TowXLM2p_5ewiJkcj6jjhlnkg76g"; // API key will be injected by the environment
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`API request failed with status ${response.status}`);

                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        document.getElementById('subtasks').value = text.trim();
                    } else {
                        throw new Error("No content received from AI.");
                    }

                } catch (error) {
                    console.error("AI Generation Error:", error);
                    showMessage("AI Error", "Sorry, I couldn't generate subtasks right now. Please try again or enter them manually.");
                } finally {
                    generateSubtasksBtn.disabled = false;
                    aiLoader.classList.add('hidden');
                }
            }
            
            function renderBossBattle() {
                bossBattleSection.innerHTML = '';
                if (!state.bossBattle) {
                    startBossBattleBtn.classList.remove('hidden');
                    return;
                }
                startBossBattleBtn.classList.add('hidden');

                const { name, description, hp, maxHp, subtasks } = state.bossBattle;
                const hpPercent = (hp / maxHp) * 100;

                let subtasksHtml = subtasks.map((subtask, index) => `
                    <div class="flex items-center mt-2">
                        <input type="checkbox" id="boss-subtask-${index}" data-boss-subtask-index="${index}" class="form-checkbox h-5 w-5 bg-gray-800 border-gray-600 text-red-500 rounded focus:ring-red-600" ${subtask.completed ? 'checked' : ''}>
                        <label for="boss-subtask-${index}" class="ml-3 text-gray-300 ${subtask.completed ? 'line-through text-gray-500' : ''}">${subtask.name}</label>
                    </div>
                `).join('');

                const bossCard = `
                    <div class="boss-battle-card rounded-2xl p-6 shadow-lg">
                        <h2 class="text-3xl font-bold text-red-300 text-center mb-2">${name}</h2>
                        <p class="text-center text-red-200 italic mb-4">${description}</p>
                        <div class="mb-4">
                            <div class="flex justify-between items-center mb-1"><span class="font-semibold text-red-200">Boss HP</span><span class="text-sm font-medium">${Math.round(hp)} / ${maxHp}</span></div>
                            <div class="w-full bg-gray-700 rounded-full h-5"><div class="bg-red-500 h-5 rounded-full transition-all duration-500" style="width: ${hpPercent}%;"></div></div>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg text-red-200 mb-2">Weak Points:</h3>
                            ${subtasksHtml}
                        </div>
                    </div>
                `;
                bossBattleSection.innerHTML = bossCard;
            }
            
            function completeBossSubtask(index, isCompleted) {
                const boss = state.bossBattle;
                if (!boss || boss.subtasks[index].completed === isCompleted) return;

                boss.subtasks[index].completed = isCompleted;
                const damagePerSubtask = boss.maxHp / boss.subtasks.length;
                
                if (isCompleted) {
                    boss.hp = Math.max(0, boss.hp - damagePerSubtask);
                } else {
                    boss.hp = Math.min(boss.maxHp, boss.hp + damagePerSubtask);
                }

                if (boss.hp === 0) {
                    showMessage("Victory!", `You have defeated ${boss.name}!\n\nYou earned a massive 250 XP bonus!`);
                    gainXp(250);
                    state.bossBattle = null;
                }
                renderBossBattle();
                renderTasks();
                saveGameState();
            }

            async function createBossBattle(theme) {
                bossLoader.classList.remove('hidden');
                const prompt = `You are a Dungeon Master for a productivity RPG. A student wants a "Boss Battle" based on the theme: "${theme}". Create a boss with a cool, thematic name, a short, intimidating description, and a list of 5 challenging but actionable subtasks (its "weak points"). Respond in JSON format like this: {"name": "...", "description": "...", "subtasks": ["...", "...", "..."]}`;
                
                try {
                    const payload = {
                        contents: [{ role: "user", parts: [{ text: prompt }] }],
                        generationConfig: { responseMimeType: "application/json" }
                    };
                    const apiKey = "AIzaSyAI4X1TowXLM2p_5ewiJkcj6jjhlnkg76g"; // API key will be injected
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    
                    const result = await response.json();
                    const bossData = JSON.parse(result.candidates[0].content.parts[0].text);
                    
                    state.bossBattle = {
                        name: bossData.name,
                        description: bossData.description,
                        hp: 100,
                        maxHp: 100,
                        subtasks: bossData.subtasks.map(name => ({ name, completed: false }))
                    };
                    renderBossBattle();
                    renderTasks();
                    saveGameState();
                    bossBattleModal.classList.add('hidden');
                    bossBattleForm.reset();

                } catch (error) {
                    console.error("Boss Generation Error:", error);
                    showMessage("Summoning Failed", "The ancient magics failed. Please try summoning the boss again.");
                } finally {
                    bossLoader.classList.add('hidden');
                }
            }

            async function getPepTalk() {
                pepTalkBtn.disabled = true;
                pepTalkBtn.innerHTML = '<div class="loader"></div>';

                const highPriorityTasks = state.tasks.filter(t => t.priority === 'high').map(t => t.name).join(', ');
                const context = `My character is Level ${state.character.level} with ${state.character.hp} HP. I'm facing these high-priority tasks: ${highPriorityTasks || 'None'}.`;
                const prompt = `Act as a motivational RPG companion. My character stats and situation are: ${context}. Give me a short, inspiring, and slightly epic pep talk to get me motivated.`;

                try {
                     const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                     const apiKey = "AIzaSyAI4X1TowXLM2p_5ewiJkcj6jjhlnkg76g"; // API key will be injected
                     const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                     const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                     if (!response.ok) throw new Error(`API Error: ${response.status}`);
                     const result = await response.json();
                     const pepTalk = result.candidates[0].content.parts[0].text;
                     showMessage("A Word of Encouragement", pepTalk);
                } catch(error) {
                    console.error("Pep Talk Error:", error);
                    showMessage("Silence...", "Your companion seems lost in thought. Try again in a moment.");
                } finally {
                    pepTalkBtn.disabled = false;
                    pepTalkBtn.innerHTML = '<span class="mr-2">‚ú®</span> Get Pep Talk';
                }
            }
            
            async function generateCharacterFromPhoto(base64ImageData) {
                photoLoader.classList.remove('hidden');
                submitPhotoBtn.disabled = true;

                const prompt = `Analyze the person in this image. Respond with only a JSON object describing their features. The JSON should have keys: "hairColor" (a hex code string for the dominant hair color), "skinColor" (a hex code string for the average skin tone), and "hasGlasses" (a boolean). Example: {"hairColor": "#1C1C1C", "skinColor": "#F1C27D", "hasGlasses": false}`;

                try {
                    const payload = {
                        contents: [{
                            parts: [
                                { text: prompt },
                                { inlineData: { mimeType: "image/jpeg", data: base64ImageData } }
                            ]
                        }],
                        generationConfig: { responseMimeType: "application/json" }
                    };
                    const apiKey = "AIzaSyAI4X1TowXLM2p_5ewiJkcj6jjhlnkg76g"; // API key will be injected
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    
                    const result = await response.json();
                    const features = JSON.parse(result.candidates[0].content.parts[0].text);
                    
                    state.characterCustomization = { ...state.characterCustomization, ...features };
                    rebuildCharacter();
                    saveGameState();
                    
                    photoModal.classList.add('hidden');

                } catch (error) {
                    console.error("Character Generation Error:", error);
                    showMessage("Creation Failed", "The AI couldn't create a character from that photo. Please try a different one.");
                } finally {
                    photoLoader.classList.add('hidden');
                    submitPhotoBtn.disabled = false;
                }
            }

            // --- EVENT LISTENERS ---
            createFromPhotoBtn.addEventListener('click', () => {
                photoModal.classList.remove('hidden');
                photoUpload.value = '';
                photoPreviewContainer.classList.add('hidden');
                submitPhotoBtn.disabled = true;
            });

            cancelPhotoBtn.addEventListener('click', () => {
                photoModal.classList.add('hidden');
            });
            
            photoUpload.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        photoPreview.src = e.target.result;
                        photoPreviewContainer.classList.remove('hidden');
                        submitPhotoBtn.disabled = false;
                    }
                    reader.readAsDataURL(file);
                }
            });

            submitPhotoBtn.addEventListener('click', () => {
                const base64String = photoPreview.src.split(',')[1];
                generateCharacterFromPhoto(base64String);
            });

            // Gender selection handler
            if (genderSelect) {
                genderSelect.value = state.characterCustomization.gender || 'male';
                genderSelect.addEventListener('change', (e) => {
                    state.characterCustomization.gender = e.target.value;
                    rebuildCharacter();
                    saveGameState();
                });
            }

            // Name editing functionality
            editNameBtn.addEventListener('click', () => {
                characterNameInput.value = state.characterCustomization.name;
                nameModal.classList.remove('hidden');
                characterNameInput.focus();
            });

            cancelNameBtn.addEventListener('click', () => {
                nameModal.classList.add('hidden');
            });

            saveNameBtn.addEventListener('click', () => {
                const newName = characterNameInput.value.trim();
                if (newName) {
                    state.characterCustomization.name = newName;
                    updateCharacterName();
                    saveGameState();
                    nameModal.classList.add('hidden');
                    showMessage("Name Updated!", `Your character is now called "${newName}"!`);
                }
            });

            characterNameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    saveNameBtn.click();
                }
            });

            // Authorization & Friends functionality
            loginBtn.addEventListener('click', () => {
                if (state.isLoggedIn && state.username) {
                    showMessage("Already Logged In", `You're logged in as @${state.username}. You can change your username by resetting your progress.`);
                } else {
                    loginModal.classList.remove('hidden');
                    usernameInput.value = state.username || '';
                    usernameInput.focus();
                }
            });

            searchFriendBtn.addEventListener('click', () => {
                if (!state.isLoggedIn) {
                    showMessage("Login Required", "Please create a username first to search for friends.");
                    return;
                }
                searchModal.classList.remove('hidden');
                searchUsername.value = '';
                searchResults.innerHTML = '';
                searchUsername.focus();
            });

            inviteFriendBtn.addEventListener('click', () => {
                inviteModal.classList.remove('hidden');
                friendEmail.value = '';
                friendEmail.focus();
            });

            cancelInviteBtn.addEventListener('click', () => {
                inviteModal.classList.add('hidden');
            });

            sendInviteBtn.addEventListener('click', () => {
                const email = friendEmail.value.trim();
                if (email && email.includes('@')) {
                    sendFriendInvite(email);
                    inviteModal.classList.add('hidden');
                } else {
                    showMessage("Invalid Email", "Please enter a valid email address.");
                }
            });

            friendEmail.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendInviteBtn.click();
                }
            });

            // Login modal event listeners
            cancelLoginBtn.addEventListener('click', () => {
                loginModal.classList.add('hidden');
            });

            saveLoginBtn.addEventListener('click', () => {
                const username = usernameInput.value.trim();
                if (username && username.length >= 3) {
                    saveUsername(username);
                } else {
                    showMessage("Invalid Username", "Username must be at least 3 characters long.");
                }
            });

            usernameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    saveLoginBtn.click();
                }
            });

            // Search modal event listeners
            cancelSearchBtn.addEventListener('click', () => {
                searchModal.classList.add('hidden');
            });

            searchUserBtn.addEventListener('click', () => {
                const username = searchUsername.value.trim();
                if (username) {
                    searchUser(username);
                } else {
                    showMessage("Invalid Search", "Please enter a username to search for.");
                }
            });

            searchUsername.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchUserBtn.click();
                }
            });

            refreshLeaderboardBtn.addEventListener('click', renderLeaderboard);

            pepTalkBtn.addEventListener('click', getPepTalk);
            resetGameBtn.addEventListener('click', resetGameState);
            startBossBattleBtn.addEventListener('click', () => bossBattleModal.classList.remove('hidden'));
            cancelBossBtn.addEventListener('click', () => {
                bossBattleModal.classList.add('hidden');
                bossBattleForm.reset();
            });
            bossBattleForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const theme = document.getElementById('boss-theme').value;
                createBossBattle(theme);
            });
            bossBattleSection.addEventListener('click', (e) => {
                if (e.target.matches('input[type="checkbox"]')) {
                    const index = parseInt(e.target.dataset.bossSubtaskIndex);
                    completeBossSubtask(index, e.target.checked);
                }
            });

            // Timer controls
            timerStartBtn.addEventListener('click', startTimer);
            timerPauseBtn.addEventListener('click', pauseTimer);
            dayCompleteBtn.addEventListener('click', completeDay);
            
            addTaskBtn.addEventListener('click', () => {
                taskForm.reset();
                taskModal.classList.remove('hidden');
            });

            cancelBtn.addEventListener('click', () => {
                taskModal.classList.add('hidden');
            });

            messageOkBtn.addEventListener('click', () => {
                messageModal.classList.add('hidden');
            });

            generateSubtasksBtn.addEventListener('click', generateSubtasks);

            taskForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const taskName = document.getElementById('task-name').value;
                const taskPriority = document.getElementById('task-priority').value;
                const subtasks = document.getElementById('subtasks').value;
                if(!taskName || !subtasks) {
                    showMessage("Missing Info", "Please make sure your quest has a title and at least one subtask.");
                    return;
                }
                addTask(taskName, taskPriority, subtasks);
                taskModal.classList.add('hidden');
            });

            taskList.addEventListener('click', (e) => {
                const target = e.target;
                if (target.matches('input[type="checkbox"]')) {
                    const taskId = parseInt(target.dataset.taskId);
                    const subtaskIndex = parseInt(target.dataset.subtaskIndex);
                    completeSubtask(taskId, subtaskIndex, target.checked);
                } else if (target.closest('.delete-task')) {
                    const taskId = parseInt(target.closest('.delete-task').dataset.taskId);
                    deleteTask(taskId);
                } else if (target.closest('.fail-task-btn')) {
                    const taskId = parseInt(target.closest('.fail-task-btn').dataset.taskId);
                    failTask(taskId);
                } else if (target.closest('.complete-task-btn')) {
                    const taskId = parseInt(target.closest('.complete-task-btn').dataset.taskId);
                    completeTask(taskId);
                }
            });

            // Make functions globally available for onclick handlers
            window.addFriendByUsername = addFriendByUsername;
            
            // --- INITIALIZATION ---
            // Load saved game state first
            const hasLoadedState = loadGameState();
            
            init3DScene();
            updateCharacterStats();
            updateCharacterName();
            renderTasks();
            renderBossBattle();
            updateRankUI();
            // Restore timer state properly after page reload
            if (state.dailyTimer.isRunning && state.dailyTimer.startedAt) {
                // Timer was running before reload - accumulate the time that passed during the offline period
                const offlineTime = Date.now() - state.dailyTimer.startedAt;
                state.dailyTimer.accumulatedMs += offlineTime;
                state.dailyTimer.startedAt = Date.now(); // Reset start time to now
                saveGameState(); // Save the updated state
                
                // Restart the timer interval
                if (timerInterval) clearInterval(timerInterval);
                timerInterval = setInterval(updateTimerDisplay, 1000);
            }
            updateTimerDisplay();
            renderFriendsList();
            renderLeaderboard();
            
            // Show welcome message if this is a new game
            if (!hasLoadedState) {
                showMessage("Welcome to Productivity RPG!", "Your adventure begins! Complete quests to level up your character. Your progress will be automatically saved. Don't forget to create a username to connect with friends!");
            }
        });
    </script>
</body>
</html>
